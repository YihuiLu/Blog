<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,一灰,头痛记,blog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="一灰的技术博客 &raquo; RSS 2.0" href="/Blog/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="一灰的技术博客 &raquo; ATOM 1.0" href="/Blog/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/galileo-8d8763e752.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/ExSearch/ExSearch-182e5a8868.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/katex.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700&display=swap">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/c8a4ebfd3ab5f8fa9e9e7b22a859c584.json"
        }
    </script>
    
<title>Celery+jpype 卡死，Celery+Java 卡死，Celery Task 卡死 - 一灰的技术博客</title>
<meta name="author" content="一灰" />
<meta name="description" content="最近在写一个项目的时候同时使用到了Celery和jpype但是在实际使用过程中出现了Celery Task进程卡死的情况解决思路如下：首先是观察到涉及到使用jpype的代码在本地运行没有问题，代码片段如下：from jpype import *" />
<meta property="og:title" content="Celery+jpype 卡死，Celery+Java 卡死，Celery Task 卡死 - 一灰的技术博客" />
<meta property="og:description" content="最近在写一个项目的时候同时使用到了Celery和jpype但是在实际使用过程中出现了Celery Task进程卡死的情况解决思路如下：首先是观察到涉及到使用jpype的代码在本地运行没有问题，代码片段如下：from jpype import *" />
<meta property="og:site_name" content="一灰的技术博客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Blog/archives/Celery_jpype/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2020-09-08T16:58:00-00.00" />
<meta name="twitter:title" content="Celery+jpype 卡死，Celery+Java 卡死，Celery Task 卡死 - 一灰的技术博客" />
<meta name="twitter:description" content="最近在写一个项目的时候同时使用到了Celery和jpype但是在实际使用过程中出现了Celery Task进程卡死的情况解决思路如下：首先是观察到涉及到使用jpype的代码在本地运行没有问题，代码片段如下：from jpype import *" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/Blog/">一灰的技术博客</a></h1>
                        <p>花径不曾缘客扫，蓬门今始为君开</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/Blog/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Blog/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Blog/migraine/" target="_self">头痛记</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Blog/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">Celery+jpype 卡死，Celery+Java 卡死，Celery Task 卡死</h1>
            <span class="ga-post_meta ga-mono">
                <span>一灰</span>
                <time>
                    2020-09-08
                </time>
                
                in <a no-style class="category" href="/Blog/category/Python/">
                    Python
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <p>最近在写一个项目的时候同时使用到了<code>Celery</code>和<code>jpype</code></p><p>但是在实际使用过程中出现了Celery Task进程卡死的情况</p><p>解决思路如下：</p><p>首先是观察到涉及到使用<code>jpype</code>的代码在本地运行没有问题，代码片段如下：</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jpype</span> <span class="kn">import</span> <span class="o">*</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">load_trie</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="n">JClass</span><span class="p">(</span><span class="s1">&#39;java.util.TreeMap&#39;</span><span class="p">)()</span>  <span class="c1"># 创建 TreeMap 空间</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">maps</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">JClass</span><span class="p">(</span><span class="s1">&#39;com.hankcs.hanlp.collection.trie.DoubleArrayTrie&#39;</span><span class="p">)(</span><span class="n">maps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rs</span>

<span class="o">...</span>
</pre></div>
<p>经过排错后发现代码停止在以下位置：</p><div class="highlight"><pre><span></span><span class="n">rs</span> <span class="o">=</span> <span class="n">JClass</span><span class="p">(</span><span class="s1">&#39;com.hankcs.hanlp.collection.trie.DoubleArrayTrie&#39;</span><span class="p">)(</span><span class="n">maps</span><span class="p">)</span>
</pre></div>
<p>这段代码调用了Java相关的包，于是Google到了以下内容
<a href="https://github.com/jpype-project/jpype/issues/358"><a href="https://github.com/jpype-project/jpype/issues/358">https://github.com/jpype-project/jpype/issues/358</a></a></p><p>在这个issues中提到了：</p><blockquote>
<p>Wow that is failing in a very strange spot. When you said failed in a thread I figured it would be in the proxy code, but this is a fail on getting environment variables on startup. Are you sure that you don't have more than one JVM started? Your module doesn't do a check for isJVMStarted, but I thought that we have explicit checks to prevent a fail there so that seems unlikely. The trace also does not show a second call.
My next best guess is this is a security violation. I don't know much about celery, but it may be possible that it is trying to start the JVM from within some type of sand box. My approach would be to instrument the call to JPEnv::CreateJavaVM to record all the inputs that are being passed to JVM and see if I was sure that nothing bad got sent to the JVM call. As you can see in the trace, we haven't even made contact with the JVM, so assuming we are providing it with valid inputs the bug is likely in the JVM and not within JPype.
The last option here though it seems unlikely is the shared memory loader for the jvm has somehow failed. The only thing that we do with the JVM before this point is loading the shared library into memory. On architectures with mixed executable files (32/64) this can often go wrong leading to a bad entry point. But as you ran to the Parse locale it seems unlikely.</p></blockquote>
<blockquote>

<pre><code>C  [libjava.dylib+0xd2a7]  getMacOSXLocale+0x123
C  [libjava.dylib+0xd353]  setupMacOSXLocale+0x12
C  [libjava.dylib+0xd765]  ParseLocale+0x2e
C  [libjava.dylib+0xd4ef]  GetJavaProperties+0x183
C  [libjava.dylib+0x5cbb]  Java_java_lang_System_initProperties+0x30
j  java.lang.System.initProperties(Ljava/util/Properties;)Ljava/util/Properties;+0
j  java.lang.System.initializeSystemClass()V+13
v  ~StubRoutines::call_stub
V  [libjvm.dylib+0x2f0b3a]
V  [libjvm.dylib+0x2f0d35]
V  [libjvm.dylib+0x2f0ead]
V  [libjvm.dylib+0x57313b]
V  [libjvm.dylib+0x3271b2]
C  [_jpype.cpython-36m-darwin.so+0x242cb]  _ZN5JPEnv12CreateJavaVMEPv+0x3b
The specific failure point is

 // Get the entry points in the shared library
 loadEntryPoints(vmPath);  &lt;== Could load invalid pointers

 JavaVMInitArgs jniArgs;
 jniArgs.options = NULL;

 // prepare this ...
 jniArgs.version = USE_JNI_VERSION;
 jniArgs.ignoreUnrecognized = ignoreUnrecognized;

 jniArgs.nOptions = (jint)args.size();
 jniArgs.options = (JavaVMOption*)malloc(sizeof(JavaVMOption)*jniArgs.nOptions);
 memset(jniArgs.options, 0, sizeof(JavaVMOption)*jniArgs.nOptions);
 for (int i = 0; i &lt; jniArgs.nOptions; i++)
 {
   jniArgs.options[i].optionString = (char*)args[i].c_str();  &lt;== All options should be valid
 }
 JPEnv::CreateJavaVM((void*)&amp;jniArgs);  &lt;== Everything in the structure should be valid at this point
 free(jniArgs.options);
The only trace I could find that was similar is

https://bugs.openjdk.java.net/secure/attachment/72587/hs_err_pid55488.log
</code></pre>
</blockquote>
<p>再加上这个issues中的其他信息，猜测是在<code>celery</code>的<code>worker</code>中因为某种环境的影响导致<code>Java</code>无法正常运行，并与<code>JVM</code>有关</p><p>并且最后他们提到</p><blockquote>
<p>Starting after the fork is by far the safest approach.</p></blockquote>
<p>然后这个问题还关闭了，这就郁闷了，但请教同事建议我看了这个：
<a href="https://stackoverflow.com/questions/12003221/celery-task-schedule-ensuring-a-task-is-only-executed-one-at-a-time"><a href="https://stackoverflow.com/questions/12003221/celery-task-schedule-ensuring-a-task-is-only-executed-one-at-a-time">https://stackoverflow.com/questions/12003221/celery-task-schedule-ensuring-a-task-is-only-executed-one-at-a-time</a></a></p><p>最后找到了：<a href="https://docs.celeryproject.org/en/stable/reference/celery.bin.worker.html#cmdoption-celery-worker-p"><a href="https://docs.celeryproject.org/en/stable/reference/celery.bin.worker.html#cmdoption-celery-worker-p">https://docs.celeryproject.org/en/stable/reference/celery.bin.worker.html#cmdoption-celery-worker-p</a></a></p><p>猜测跟worker运行时的线程约束有关，于是乎测试：</p>
<pre><code>-P, --pool
Pool implementation:

prefork (default), eventlet, gevent, threads or solo.
</code></pre>
<p>##然后就顺利的成功了</p><p>最后的worker启动命令如下：</p>
<pre><code>celery -A celery_app.worker:celery worker -c 4 -l info -P solo
</code></pre>
<p>重点在于</p>
<pre><code>-P solo
</code></pre>
<p>这个命令指定了每个worker只能用单线程模式执行，这样就不会导致JVM出现不可预知的问题</p><p>经过测试在指定 <code>-P solo</code> 的同时可以指定 <code>-c</code></p><p>仓促记录，日后修改</p>
            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Blog/tag/Celery/">#Celery</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Blog/tag/jpype/">#jpype</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <h3>没有了</h3>
        <p class="yue">这是最新的文章</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/Blog/archives/sqlalchemy_db/">sqlalchemy 绑定多个数据库</a>
        <p class="yue">#绑定多个数据库</p>
    </div>

</section>


    
        <script>
            var initValine = function () {
                new Valine({"enable": true, "el": "#vcomments", "appId": "FHu0SCPDeyBjMY4s0ECouzDf-gzGzoHsz", "appKey": "UecRNirhvv66x0fxlpKjmFSk"});
            }
        </script>
        <script defer src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js' onload="initValine()"></script>
        <div id="vcomments"></div>
    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">一灰的技术博客</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2020 一灰</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="GitHub" href="https://github.com/YihuiLu" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2019-2-18T16:51+08:00"
                    </script>
                    <script src="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/galileo-7c8cea54ab.js"></script>
                </footer>
            </div>
        </div>
    </div>

    <!--katex-->
    <script defer src="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    <script src="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/YihuiLu/Blog@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    
    </body>
</html>